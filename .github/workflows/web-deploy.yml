name: Web - Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - '.github/workflows/web-deploy.yml'
    tags-ignore:
      - '**'

permissions: {} # job-level permissions only

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # Never cancel: mid-sync cancellation leaves bucket in partial state

jobs:
  deploy:
    name: Build and Deploy
    permissions:
      contents: read   # checkout source
      id-token: write  # REQUIRED: lets GitHub issue the OIDC JWT for AWS role assumption
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          cache: false
          experimental: true

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        working-directory: web
        run: pnpm install --frozen-lockfile

      - name: Build
        working-directory: web
        run: pnpm run build
        env:
          VITE_API_URL: ${{ vars.API_URL }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-web-deploy
          aws-region: eu-west-1

      - name: Sync to S3
        run: |
          aws s3 sync web/build/ s3://${{ vars.S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"
          # HTML files: short cache (must revalidate so new deploys take effect quickly)
          aws s3 sync web/build/ s3://${{ vars.S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html" \
            --exclude "*"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CF_DISTRIBUTION_ID }} \
            --paths "/*"
